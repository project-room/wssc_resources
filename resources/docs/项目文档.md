## 1. 运行开发服务器

### 1. 前端

1. 配置 Nginx

前端需要通过 Nginx 进行反向代理和响应静态文件. 下面是一个完整的示例. 需要注意的部分有:

- `listen` - Nginx 响应的端口.
- `server_name` - 需要修改为我们本机的 IP 地址. 用户也将通过该地址访问系统.
- `root` - 需要修改为前端代码 dist 文件夹地址, Nginx 从这个目录下响应静态文件.
- `access_log`, `error_log` - Nginx 日志文件路径, 需要确保这两个日志文件是存在且 Nginx 有写入权限的.
- django `proxy_pass` - 这是 Nginx 代理到后端开发服务器的 IP 地址. 需要将 `http://localhost:8009` 替换为后端相应的 IP 和端口.
- onlyofficeplugin `proxy_pass` - 这是 Nginx 代理到 Minio 对象存储响应 OnlyOffice 插件的地址, 需要将 `http://localhost:8029` 替换为 Minio 相应的 IP 和端口. 注意最后是没有 `/` 的.

```
server {
    listen                      9000;
    server_name                 192.168.2.193 192.168.2.188 0.0.0.0 localhost;
    client_max_body_size        10m;

    gzip_vary                   on;
    gzip_proxied                any;
    gzip_comp_level             6;
    gzip_buffers                16 8k;
    gzip_http_version           1.1;
    gzip_types                  text/plain text/css application/json application/x-javascript;
    charset                     utf-8;

    root               /media/pw/workspace/_current/wssc/frontend/dist/;
    access_log         /var/www/project_name/logs/nginx/access.log;
    error_log          /var/www/project_name/logs/nginx/error.log;

    error_page         404 /404.html;

    # frontend default index
    location = / {
        index          index.html;
    }

    # frontend static files
    location ^~ /static/ {
    }

    # django server apis
    location ^~ /api/ {
        proxy_pass http://localhost:8009/api/;
    }

    # django admin page
    location ^~ /admin/ {
        proxy_pass http://localhost:8009/admin/;
    }

    # django admin static files
    location ^~ /static/admin/ {
        proxy_pass http://localhost:8009/static/admin/;
    }

    location ^~ /static/jsoneditor/ {
        proxy_pass http://localhost:8009/static/jsoneditor/;
    }

    location ^~ /static/django-jsoneditor/ {
        proxy_pass http://localhost:8009/static/django-jsoneditor/;
    }

    location ~* \.(html)$ {
    }
    
    location ^~ /onlyofficeplugin/ {
        autoindex  on;
        proxy_pass http://localhost:8029;
    }
 
    # front end
    location / {
        try_files       $uri $uri.html =404;
    }
}

```

2. 配置前端 urls.js
 
前端需要的后端接口地址, 统一写在 `frontend/dist/static/js/common/urls.template` 中. 我们需要将 `urls.template` 中的相关地址替换后, __另存为__ `frontend/dist/static/js/common/urls.js`. 

>
> 在自动部署时, docker 会根据指定的地址, 通过 `urls.template` 文件生成 `urls.js` 文件, 因此
> 1. 不能删除 `urls.template` 文件
> 2. 当相应接口有更改时, 必须修改 `urls.template` 文件
> 

3. 检查 Nginx 配置, 启动 Nginx (Ubuntu)

- `sudo nginx -t` - 检查 Nginx 配置
- `sudo service nginx start` - 启动 Nginx 

4. 访问 `http://<server_name>:<listen>/` 地址, 测试是否能够使用.

### 2. 后端

1. 启动依赖的服务

部署后端前, 应该首先安装或使用 Docker 运行 Minio, MySQL 5.7, Redisearch, OnlyOffice documentserver 这四项服务.

2. 安装 DocxFactory

如果是在 Linux 上安装, 假设 `${BACKEND}` 是后端代码地址

- `cd ${BACKEND}/resources/docxfactory`
- `sudo bash ./install.sh`

然后根据输出的日志, 检查是否安装成功.

如果是在 Windows 上安装, 请阅读 wssc_resources 仓库 `resources/docxfactory/docx_factory_install_n_tutorial.pdf`, 按照文档中给出的步骤安装.

3. 安装其他 Python 包依赖

`pip3 install -r ${BACKEND}/requirements.txt`

4. 编辑配置文件

我们是通过环境变量的方式指定各种配置的. 在本代码仓库中, 有一个用于本地开发的脚本文件: `${BACKEND}/dev_env.sh`. 编辑该文件, 将各服务的 IP 地址进行替换. 然后通过 

`source ${BACKEND}/dev_env.sh` 来使这些环境变量生效.

5. 迁移数据库

- `python3 manage.py makemigrations`
- `python3 manage.py migrate`

6. 启动开发服务器

注意, 开发服务器应该运行在上一节 Nginx 配置后端服务指定的端口上.

`python3 manage.py runserver 0.0.0.0:<IP>`

## 2. 手动安装各服务时的参考

仅供参考, 不建议使用

## 1. 说明

应用服务器运行在 8009 端口. 默认安装位置是 `~/sites/WenShuShengCheng/`
onlyoffice 文档服务器运行在 8019 端口. 默认安装位置是 `~/sites/minio/`
minio 对象存储运行在 8029 端口. 默认安装位置是 `~/sites/onlyoffice/documentserver/`

## 2. 安装步骤

### 1. 安装 docker, mysql 5.7, uwsgi, nginx, supervisord(10.1), python3 环境

1. 需要特别注意的是: 

    当 Django 项目激活 `USE_TZ` 选项时, 要想对 `DateTimeField` 的时间作查找, mysql 需要添加时区信息. 首先 pip 安装 `pytz`, 然后执行:

    ```
    sudo mysql_tzinfo_to_sql /usr/share/zoneinfo/ | mysql -u <username> -p <password> mysql
    ```

### 2. 安装 OnlyOffice

1. 创建文件夹:

    ```
    # ~/sites/onlyoffice 是自定义的文件夹, 可以修改
    
    mkdir -p ~/sites/onlyoffice/documentserver
    ```

2. 使用 docker 运行: 
    
    ```
    # 复制下方命令
    sudo docker run -i -t -d -p 8019:80 --restart=always -v ~/sites/onlyoffice/documentserver/logs:/var/log/onlyoffice  -v ~/sites/onlyoffice/documentserver/data:/var/www/onlyoffice/Data  -v ~/sites/onlyoffice/documentserver/lib:/var/lib/onlyoffice -v ~/sites/onlyoffice/documentserver/db:/var/lib/postgresql -v ~/sites/onlyoffice/documentserver/fonts:/usr/share/fonts -v ~/sites/onlyoffice/documentserver/mydata:/mydata onlyoffice/documentserver

    # 便于查看的形式
    sudo docker run -i -t -d -p 8019:80 --restart=always 
    -v ~/sites/onlyoffice/documentserver/logs:/var/log/onlyoffice  
    -v ~/sites/onlyoffice/documentserver/data:/var/www/onlyoffice/Data  
    -v ~/sites/onlyoffice/documentserver/lib:/var/lib/onlyoffice 
    -v ~/sites/onlyoffice/documentserver/db:/var/lib/postgresql 
    -v ~/sites/onlyoffice/documentserver/fonts:/usr/share/fonts 
    -v ~/sites/onlyoffice/documentserver/mydata:/mydata onlyoffice/documentserver

    # 本机开发的
    sudo docker run -i -t -d -p 8019:80 --restart=always -v /home/pw/workspace/docserver/_onlyoffice/documentserver/logs:/var/log/onlyoffice -v /home/pw/workspace/docserver/_onlyoffice/documentserver/data:/var/www/onlyoffice/Data -v /home/pw/workspace/docserver/_onlyoffice/documentserver/lib:/var/lib/onlyoffice -v /home/pw/workspace/docserver/_onlyoffice/documentserver/db:/var/lib/postgresql -v /home/pw/workspace/docserver/_onlyoffice/documentserver/fonts:/usr/share/fonts -v /home/pw/workspace/docserver/_onlyoffice/documentserver/mydata:/mydata onlyoffice/documentserver
    ```

    其中, 

    - `/var/log/onlyoffice` for Document Server logs
    - `/var/www/onlyoffice/Data` for certificates
    - `/var/lib/onlyoffice` for file cache
    - `/var/lib/postgresql` for database
    - `/mydata` 是自定义的文件夹，方便传输复制文件


3. 安装完成后, 浏览器访问 `http://ip:8019/welcome/`, 应该能够看到欢迎界面. 如果无法访问, 检查 SELinux 设置.

4. 为 document server 安装中文字体.
    
    ```
    # 首先将中文字体复制到字体文件夹下
    cp -r ~/sites/WenShuShengCheng/resources/packages/zh-fonts ~/sites/onlyoffice/documentserver/fonts

    # 登入容器终端
    sudo docker exec -it <container ID> /bin/bash

    # container ID 使用 sudo docker container ls | grep onlyoffice 查看

    # 使用 onlyoffice 提供的工具安装字体. 注意, 生成的字体仅包含我们复制进去的字体. 
    /usr/bin/documentserver-generate-allfonts.sh

    # 成功时会生成 /var/www/onlyoffice/documentserver/sdkjs/common/AllFont.js 文件. 
    # 正常的输出信息如下: 
        Generating AllFonts.js, please wait...Done
        onlyoffice-documentserver:docservice: stopped
        onlyoffice-documentserver:docservice: started
        onlyoffice-documentserver:converter: stopped
        onlyoffice-documentserver:converter: started
    ```

    > onlyoffice 在 docker 内的安装路径位于 `/var/www/onlyoffice`

5. 修改常量 `LICENSE_CONNECTIONS`


### 3. 安装 DocxFactory 依赖

1. 将 `DocxFactoryLinux64.tar.gz` 解压至 `/opt` 文件夹: 

    ```
    # ~/sites/WenShuShengCheng/resources/packages/ 文件夹中有该文件

    sudo tar -zxvf ~/sites/WenShuShengCheng/resources/packages/DocxFactoryLinux64.tar.gz -C /opt
    ```

2. 将 `DocxFactory/lib` 文件夹加入库搜索目录:

    ```
    sudo echo /opt/DocxFactory/lib/ > /etc/ld.so.conf.d/DocxFactory.conf
    sudo chmod 666 /etc/ld.so.conf.d/DocxFactory.conf
    ldconfig
    ```

    > 如果 gcc 报错, 安装 `gcc-c++` 环境 或 `g++` 环境
    > DocxFactory 尽量安装在 /opt 文件夹下, 否则 docxfactory 包无法导入

3. 安装 DocxFactory python 模块:

_使用 venv 时, 只要系统中已经安装过 DocxFactory, 只需要使用 venv 内的 python 解释器执行以下命令即可_

    ```
    cd /opt/DocxFactory/python
    python3 setup.py install
    ```

    > 需要安装 `python3-devel` 依赖来编译 python 模块.

4. 测试 DocxFactory 模块是否安装成功

    ```
    python3
    > from docxfactory import WordProcessingCompiler

    # 导入成功即表明安装成功
    # 很有可能会报各种错误, 通常是因为某些依赖没有安装, 只需要安装缺失的依赖即可. 例如如下的报错: 

        Traceback (most recent call last):
          File "<stdin>", line 1, in <module>
          File "/opt/DocxFactory/python/docxfactory.py", line 28, in <module>
            _docxfactory = swig_import_helper()
          File "/opt/DocxFactory/python/docxfactory.py", line 20, in swig_import_helper
            import _docxfactory
        ImportError: libXt.so.6: cannot open shared object file: No such file or directory

    # 原因即是 缺乏依赖 libxt-dev. apt 安装即可.
    ```

### 4. 安装 python 模块

    ```
    cd ~/sites/WenShuShengCheng/
    pip3 install -r requirements.txt
    ```

### 5. 安装 minio 并测试

1. 下载可执行文件: 

    ```
    # 这里的 ~/sites/minio/ 是自定义的文件夹, 可以修改

    mkdir ~/sites/minio
    cd ~/sites/minio/
    wget https://dl.minio.io/server/minio/release/linux-amd64/minio
    ```

2. 更新配置文件, 需要修改配置中的用户名, 密码与应用服务器地址.

    ```
    cp ~/sites/WenShuShengCheng/resources/packages/config.json ~/sites/minio/config.json

    vi ~/sites/minio/config.json

    # 找到 credential 配置项. 默认的配置是:

        "credential": {
            "accessKey": "minio",
            "secretKey": "minio123"
        },

    # 找到 webhook 配置项. 默认的配置是:
    # endpoint 地址即是应用服务器地址. 如果无需修改, 退出 vim 即可

        "webhook": {
            "1": {
                "enable": true,
                "endpoint": "http://0.0.0.0:8009/api/v2/doc_upload_callback/"
            }
        },
    ```


3. 赋予权限, 启动并测试: 

    ```
    chmod +x ./minio
    
    # minio 的默认配置文件是 ~/.minio/config.json
    # 指定配置文件地址 (-config-dir 或 -C. 这里目前使用的是默认配置), 端口地址 (--address), 数据保存地址. 

    # sudo ./minio server -config-dir ~/sites/minio/ --address :8029 ~/sites/minio/data/
    sudo ./minio server -C ~/sites/minio/ --address :8029 ~/sites/minio/data/

    # 正常运行状态的日志如下:

        Drive Capacity: 10 GiB Free, 37 GiB Total

        Endpoint:  http://ip:8029
        AccessKey: minio 
        SecretKey: minio123 
        SQS ARNs:  arn:minio:sqs::1:webhook

        # 接下来是一些使用方法
    ```

3. 开启一个新的终端, 安装 mc 并启动:

    ```
    cd ~/sites/minio/
    wget https://dl.minio.io/client/mc/release/linux-amd64/mc

    chmod +x ./mc

    # 添加 minio 服务器至 mc 客户端

    ./mc config host add <minio 服务器别名, 例如: minio-dev> <minio 服务器地址> <ACCESS-KEY> <SECRET-KEY>

    # 查看帮助: ./mc --help
    ```

4. 测试安装

    访问 http://ip:8029/, 如果出现 minio 登录界面, 即表明 minio 运行正常. 

5. 测试完成后即可关闭 minio 与 mc.

### 6. 配置应用服务器

修改文件: `~/sites/WenShuShengCheng/Court_book/settings.py`

1. 配置数据库用户名和密码
2. 配置各服务地址:

    ```
    # 这里的 ip 不能使用 localhost, 或 127.0.0.1 或 0.0.0.0

    LOCAL_HOST = 'ip:8009'
    ONLYOFFICE_HOST = 'ip:8019'
    MINIO_HOST = 'ip:8029'

    # 默认的 minio 服务器用户名和密码. 如果没有更改可以忽略.

    MINIO_ACCESS_KEY = 'minio'
    MINIO_SECRET_KEY = 'minio123'
    ```

修改文件: `~/sites/WenShuShengCheng/resources/tools/dev.sh` (该脚本仅用来在开发时启动开发服务器)

1. 配置应用服务器安装位置, minio 安装位置和 python 编译器命令:

    ```
    # 以下是默认位置. 如果不需要修改退出即可.

    workspace="~/sites/WenShuShengCheng"
    minioDir="~/sites/minio"
    workingPython="/usr/local/python35/bin/python3.5"       # 可能需要修改 python 路径

    # 如果使用 venv, 修改 workingPython如下
    #workingPython="${workspace}/venv/bin/python3"
    ```

### 7. 创建数据库
    
    ```
    CREATE DATABASE docserver CHARSET="utf8";
    SHOW DATABASES;
    ```

### 8. 迁移数据库, 启动开发服务器

    ```
    python3 ~/sites/WenShuShengCheng/manage.py makemigrations
    python3 ~/sites/WenShuShengCheng/manage.py migrate

    sudo bash ~/sites/WenShuShengCheng/resources/tools/dev.sh
    ```

### 9. 填充默认的案件阶段数据, 以及管理员用户信息.

    ```
    python3 ~/sites/WenShuShengCheng/manage.py loaddata main_stages.json auth_superuser.json

    # 添加的管理员信息如下:
    # username: admin
    # password: rootroot
    # email: admin@fakesite.com
    # first_name: '管理员'
    ```

### 9. 访问服务器地址 `http://ip:8009/login/` 登录测试

### 10. 配置服务器

#### 10.1 安装 uwsgi

服务器存在多个版本的 python.  如果python 2.7 不会用来运行 uwsgi, 那么可以直接使用 `pip3 install uwsgi`.

否则如果有多个版本的 uwsgi 安装在服务器上, 需要手动编译 uwsgi 源码:


    ```
    cd ~/download

    wget https://pypi.python.org/packages/7d/11/2b1d3c88fda1049eb5ac8930f7622c29665bea04241fe0f28ff89436bae2/uwsgi-2.0.16.tar.gz#md5=efa3adb73b99f7f7914ca47bcddcf184

    tar -zxf ./uwsgi-2.0.16.tar.gz

    cd ./uwsgi-2.0.16.tar.gz

    UWSGI_BIN_NAME=/usr/bin/uwsgi_python3 python3 uwsgiconfig.py --build

    # 而后在运行 uwsgi 时, 使用 /usr/bin/uwsgi_python3
    ```

#### 10.2 配置 uwsgi 配置
    
1. 安装 uwsgi python3 插件
    
    ```
    sudo apt install uwsgi-plugin-python3
    ```

2. 编辑配置文件 `/root/sites/WenShuShengCheng.ini`

    ```
    [uwsgi]
    chdir=/root/sites/WenShuShengCheng
    socket=/var/run/WenShuShengCheng.sock
    chmod-socket=666
    module=Court_book.wsgi:application
    master=True
    pidfile=/tmp/WenShuShengCheng.pid
    vacuum=True
    max-requests=5000
    processes=4
    daemonize=/var/log/uwsgi/WenShuShengCheng.log
    plugins=python3
    ```

3. 运行测试:

    ```
    uwsgi -i /root/sites/WenShuShengCheng.ini
    ```

#### 10.2 安装 supervisord

    ```
    cd ~/download/          # 下载文件夹, 可以修改

    # 下载源码包
    wget https://pypi.python.org/packages/44/60/698e54b4a4a9b956b2d709b4b7b676119c833d811d53ee2500f1b5e96dc3/supervisor-3.3.4.tar.gz#md5=f1814d71d820ddfa8c86d46a72314cec

    # 解压
    tar -zxf supervisor-3.3.4.tar.gz 

    # 安装. 注意 supervisor 只支持 python 2.4+
    cd ./supervisor-3.3.4/
    python setup.py install 
    ``` 

#### 10.3 配置 supervisord 
    
    日志文件的位置可以修改, 如果文件不存在需要提前创建. 这里的日志文件有:

        - /root/sites/WenShuShengCheng/logs/minio/debug.log
        - /root/sites/logs/WenShuShengCheng-error.log
        - /root/sites/logs/WenShuShengCheng.log

    ```
    # 注意, supervisord 按照一下顺序检查配置文件并使用第一个配置文件:
    #   $CWD/supervisord.conf
    #   $CWD/etc/supervisord.conf
    #   /etc/supervisord.conf
    #   /etc/supervisor/supervisord.conf

    # 创建默认 supervisord 配置文件
    sudo echo_supervisord_conf > /etc/supervisord.conf

    # 添加或修改配置:

    [inet_http_server] 
    port=*:9001        
    username=admin  
    password=rootroot 

    [program:minio]
    command=/root/sites/minio/minio server -C /root/sites/minio --address :8029 /root/sites/minio/data/
    redirect_stderr=true
    stderr_logfile=/root/sites/WenShuShengCheng/logs/minio/debug.log

    [program:docserver]
    command=uwsgi -i /root/sites/WenShuShengCheng.ini
    redirect_stderr=true
    stderr_logfile=/root/sites/logs/WenShuShengCheng-error.log
    stdout_logfile=/root/sites/logs/WenShuShengCheng.log
    ```


#### 10.4 测试 supervisord

1. 运行 $BINDIR/supervisord 
2. 访问 `http://ip:9001/` 查看 supervisord 控制台. 查看是否正常启停服务, 及各服务是否正常.

#### 10.5 配置 nginx

- `/etc/nginx/sites-available/minio`

    ```
    server {
        listen 8029;
        server_name <ip>;
        location / {
            proxy_set_header Host $http_host;
            proxy_pass http://localhost:8029;
        }
    }
    ```

- `/etc/nginx/sites-available/docserver`
    
    > 可能需要修改 python site-packages 路径, 可以使用 `pip3 show django` 查看.

    ```
    server {
        listen      8009;
        server_name <ip>;
        client_max_body_size    10m;

        gzip_vary       on;
        gzip_proxied    any;
        gzip_comp_level 6;
        gzip_buffers    16 8k;
        gzip_http_version   1.1;
        gzip_types  text/plain  text/css  application/json  application/x-javascript;

        location / {
            include         uwsgi_params;
            uwsgi_pass      unix:///var/run/WenShuShengCheng.sock
            uwsgi_param     UWSGI_SCHEME $scheme;
            uwsgi_param     SERVER_SOFTWARE nginx/$nginx_version;
        }

        location /static/ {
            alias /root/sites/WenShuShengCheng/static/;
            index index.html index.htm;
        }
        location /static/admin/ {
            alias /usr/lib/python3.5/site-packages/django/contrib/admin/static/admin/;
            index index.html index.htm;
        }
        charset utf-8;
    }
    ```

- `/etc/nginx/sites-available/onlyoffice`

    ```
    server {
        listen 8019;
        server_name <ip>;
        location / {
            proxy_set_header Host $http_host;
            proxy_pass http://<ip>:8019;
        }
    }
    ```

- 启动 nginx
    
    ```
    sudo service nginx configtest
    sudo service nginx reload 
    sudo service nginx status
    ```


## 3. 文书模板编辑与渲染的实现

文书模板编辑需要实现的功能有：根据文书内容制作生成模板，根据案件信息填充模板渲染成文书，模板占位符的编辑与管理。

主要难点是, 办公单位绝大多数使用 microsoft office word, 因此模板的格式需要兼容 microsoft office word. 同时根据案件信息渲染相应的内容.

microsoft office word 在 2007 版之前使用的是 doc 格式文件，该文件格式是微软内部标准格式，外界难以兼容。在2007版后，微软使用由其建立并推动的ooxml文档标准，其中 word使用docx文件.

docx 文件本质上是 zip 压缩包, 文档内容主要存在与压缩包中名为 document.xml 文件中, 内容格式是 xml. 因此兼容/操作 docx 文件主要是兼容
符合 ooxml 标准的 xml 文件格式.

可选方案有:

- 基于网页富文本编辑器实现: 前端编辑器使用网页富文本编辑器, 制作模板时将 docx 内容复制进入编辑器, 由编辑器自动转换成 html 格式, 保留文字及表格样式, 而后在后端将 html 文件进行处理, 将占位符替换为 django 模板标记语言并清除多余的 html 样式标签. 模板渲染时依据案件信息, 由 django 模板引擎填充占位符内容完成渲染, 生成 html 文件. 
    
    > __缺点是网页富文本编辑器与 word 编辑使用体验差距较大, 但是模板渲染易于实现.__

- 基于 microsoft office online 实现: 前端编辑器使用 microsoft office online, 可以提供最原生的 word 编辑体验. 模板渲染时由后端依照 ooxml 标准解析 docx 文件, 依据案件信息充 docx 文件中的占位符内容, 最后完成渲染, 生成 docx 文件. 

    > __优点是编辑体验最好, 客户不需要安装 microsoft office 软件, 缺点是 microsoft office online 服务需要使用两台独立 windows server 服务器, 其中一台为域控制服务器并且不能安装其他软件/服务.__

- 基于 html5 onlyoffice 实现: 前端编辑器使用由 html5 实现的 onlyoffice, 可以提供最接近 microsoft office 的编辑体验. 制作模板时则由用户或管理员在本地通过 microsoft office word 编辑并上传至系统. (模板编辑需要用到插入书签功能, 而 onlyoffice 尚不支持). 模板渲染时依旧由后端依照 ooxml 标准解析 docx 文件, 填充占位符内容后生成 docx 文件. 

    > __优点是客户不需要安装任何软件, 编辑体验好, 支持插件添加其他功能. 缺点是不能在线制作模板.__

- 基于 PageOffice 实现: 前端编辑器使用 PageOffice 实现, 基本上是调用客户本地 office 软件, 模板渲染方式与前两个方案相同. 

    > __优点是编辑体验好, 可以在线制作模板, 缺点是客户本地需要安装 office 软件(?).__

